- name: Install PostgreSQL
  apt:
    name: postgresql
    state: present

- name: Edit postgresql.conf for remote access
  lineinfile:
    path: /etc/postgresql/14/main/postgresql.conf
    regexp: '^#?listen_addresses =.*$'
    line: "listen_addresses = '*'"
  notify: restart postgresql

- name: Create pg_hba.conf for remote access
  blockinfile:
    path: /etc/postgresql/14/main/pg_hba.conf
    block: |
      host    all             all             0.0.0.0/0               md5
  notify: restart postgresql

- name: Show remote user ID
  debug:
    var: ansible_user_uid

- name: Set permissions on temporary directory for postgres user
  become: true
  file:
    path: /run/user/{{ ansible_user_uid }}/ansible-tmp-*
    state: directory
    mode: "0700"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create database backup
  become_user: postgres
  shell: pg_dump --format=custom --file=/tmp/abc.backup --dbname=mydb --host=192.168.1.15

- name: Change postgres user password
  become_user: postgres
  postgresql_user:
    db: postgres
    name: postgres
    password: password

- name: Copy backup file to target host
  copy:
    src: /tmp/abc.backup
    dest: /tmp/
  delegate_to: 192.168.1.10

- name: Restore database on target host
  become_user: postgres
  shell: pg_restore --verbose --clean --no-acl --no-owner --host=192.168.1.10 --dbname=postgres /tmp/abc.backup
